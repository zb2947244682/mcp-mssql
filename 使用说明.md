# MCP MSSQL 工具使用说明

## 🎯 工具简介

这是一个基于MCP协议的MSSQL数据库操作工具，提供了完整的数据库连接管理、SQL执行和自动断开功能。

## 🚀 快速开始

### 1. 安装依赖
```bash
npm install
```

### 2. 启动服务
```bash
node index.js
```

### 3. 在Cursor中配置
在Cursor的`mcp.json`文件中添加以下配置：

```json
{
  "mcp-mssql": {
    "command": "node",
    "args": ["D:/Codes/MCPRepo/mcp-mssql/index.js"]
  }
}
```

## 🛠️ 工具详解

### 工具1: connect_database (连接数据库)

**功能**: 建立与MSSQL数据库的连接

**必需参数**:
- `server`: 数据库服务器地址 (如: localhost, 192.168.1.100)
- `database`: 数据库名称
- `user`: 用户名
- `password`: 密码

**可选参数**:
- `port`: 端口号，默认1433
- `encrypt`: 是否加密，默认true
- `trustServerCertificate`: 是否信任证书，默认false
- `requestTimeout`: 请求超时时间(毫秒)，默认30000
- `connectionTimeout`: 连接超时时间(毫秒)，默认30000
- `maxPoolSize`: 最大连接池大小，默认10
- `minPoolSize`: 最小连接池大小，默认0
- `idleTimeout`: 空闲超时时间(毫秒)，默认30000

**使用示例**:
```json
{
  "tool": "connect_database",
  "params": {
    "server": "localhost",
    "database": "testdb",
    "user": "sa",
    "password": "your_password",
    "port": 1433,
    "encrypt": true
  }
}
```

### 工具2: execute_sql (执行SQL查询)

**功能**: 在已连接的数据库中执行SQL查询

**必需参数**:
- `sql`: SQL语句

**可选参数**:
- `params`: 参数数组，每个参数包含name、type、value

**使用示例**:
```json
{
  "tool": "execute_sql",
  "params": {
    "sql": "SELECT * FROM users WHERE name = @userName AND age > @minAge",
    "params": [
      {
        "name": "userName",
        "type": "sql.VarChar",
        "value": "张三"
      },
      {
        "name": "minAge",
        "type": "sql.Int",
        "value": 18
      }
    ]
  }
}
```

**支持的SQL类型**:
- `sql.VarChar` - 字符串
- `sql.Int` - 整数
- `sql.Decimal` - 小数
- `sql.DateTime` - 日期时间
- `sql.Bit` - 布尔值
- `sql.NVarChar` - Unicode字符串
- 等等...

### 工具3: disconnect_database (断开连接)

**功能**: 手动断开数据库连接

**参数**: 无

**使用示例**:
```json
{
  "tool": "disconnect_database",
  "params": {}
}
```

### 工具4: get_connection_status (获取连接状态)

**功能**: 查看当前连接状态和统计信息

**参数**: 无

**使用示例**:
```json
{
  "tool": "get_connection_status",
  "params": {}
}
```

## 📊 自动断开机制

- **触发条件**: 连接建立后10秒内无任何活动
- **活动类型**: 执行SQL查询、建立新连接
- **重置时机**: 每次活动都会重置10秒计时器
- **查看倒计时**: 使用`get_connection_status`工具

## 🔄 完整工作流程

### 1. 建立连接
```json
{
  "tool": "connect_database",
  "params": {
    "server": "your_server",
    "database": "your_database",
    "user": "your_username",
    "password": "your_password"
  }
}
```

### 2. 执行查询
```json
{
  "tool": "execute_sql",
  "params": {
    "sql": "SELECT COUNT(*) as total FROM users"
  }
}
```

### 3. 查看状态
```json
{
  "tool": "get_connection_status",
  "params": {}
}
```

### 4. 断开连接
```json
{
  "tool": "disconnect_database",
  "params": {}
}
```

## 🚨 注意事项

### 安全建议
- 不要在代码中硬编码密码
- 使用强密码和适当的用户权限
- 生产环境建议启用SSL加密

### 性能优化
- 合理设置连接池大小
- 及时断开不需要的连接
- 使用参数化查询避免SQL注入

### 错误处理
- 连接失败时检查网络和认证信息
- SQL执行失败时检查语法和权限
- 查看详细的错误提示信息

## 🔍 常见问题

### Q: 连接失败怎么办？
A: 检查以下项目：
- 服务器地址和端口是否正确
- 用户名和密码是否正确
- 网络连接是否正常
- SQL Server服务是否运行
- 防火墙设置是否允许连接

### Q: SQL执行失败怎么办？
A: 检查以下项目：
- SQL语法是否正确
- 表名和字段名是否存在
- 用户是否有足够权限
- 数据库连接是否正常

### Q: 如何查看连接状态？
A: 使用`get_connection_status`工具，它会显示：
- 当前连接状态
- 连接信息
- 统计信息
- 自动断开倒计时

## 📈 最佳实践

1. **连接管理**
   - 按需连接，及时断开
   - 利用自动断开功能节省资源
   - 合理设置超时时间

2. **SQL执行**
   - 使用参数化查询防止SQL注入
   - 避免执行过大的查询
   - 处理查询结果和错误

3. **监控和调试**
   - 定期检查连接状态
   - 监控查询性能
   - 记录重要操作日志

## 🎉 总结

这个MCP MSSQL工具提供了完整的数据库操作功能，包括：
- ✅ 智能连接管理
- ✅ 安全的SQL执行
- ✅ 自动资源管理
- ✅ 详细的状态监控
- ✅ 友好的错误提示

通过合理使用这些工具，你可以轻松地在AI助手中集成MSSQL数据库操作功能！
